name: Rust CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Rust Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust (latest stable)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Run checks
        run: RUSTFLAGS="-D warnings" cargo check --verbose
    
  lint:
    name: Rust Formatter Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust (latest stable)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Install Formatter
        run: rustup component add rustfmt

      - name: Run Formatter
        run: cargo fmt --all -- --check

  test:
    name: Rust Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (latest stable)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

  review:
    name: AI Code Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: AI Code Review (gemini-2.5-flash)
        id: review_primary
        continue-on-error: true
        uses: Wandalen/wretry.action@v3.5.0
        with:
          action: AleksandrFurmenkovOfficial/ai-code-review@v0.9
          with: |
            token: ${{ secrets.GITHUB_TOKEN }}
            owner: ${{ github.repository_owner }}
            repo: ${{ github.event.repository.name }}
            pr_number: ${{ github.event.number }}
            ai_provider: google
            google_api_key: ${{ secrets.GEMINI_API_KEY }}
            google_model: gemini-2.5-flash
            include_extensions: .rs,.toml
            exclude_paths: target/
            fail_action_if_review_failed: true

      - name: AI Code Review Fallback (gemini-1.5-flash)
        if: steps.review_primary.outcome == 'failure'
        uses: Wandalen/wretry.action@v3.5.0
        with:
          action: AleksandrFurmenkovOfficial/ai-code-review@v0.9
          with: |
            token: ${{ secrets.GITHUB_TOKEN }}
            owner: ${{ github.repository_owner }}
            repo: ${{ github.event.repository.name }}
            pr_number: ${{ github.event.number }}
            ai_provider: google
            google_api_key: ${{ secrets.GEMINI_API_KEY }}
            google_model: gemini-1.5-flash
            include_extensions: .rs,.toml
            exclude_paths: target/
            fail_action_if_review_failed: true